name: "Build and Test"

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.x.x
            10.x.x

      - name: Install dependencies
        run: |
          dotnet restore
          dotnet tool restore
          dotnet tool install --global dotnet-reportgenerator-globaltool
          sudo apt-get update
          sudo apt-get install -y bc

      - name: Build all TFMs
        run: dotnet build --configuration Release /warnAsError
        
      - name: Run tests with coverage (net 9.0)
        run: |
          dotnet test --framework net9.0 --results-directory TestResults/net9.0 \
            -p:CollectCoverage=true \
            -p:CoverletOutputFormat=cobertura \
            -p:CoverletOutput=TestResults/net9.0/coverage/

      - name: Run tests with coverage (net 10.0)
        run: |
          dotnet test --framework net10.0 --results-directory TestResults/net10.0 \
            -p:CollectCoverage=true \
            -p:CoverletOutputFormat=cobertura \
            -p:CoverletOutput=TestResults/net10.0/coverage/

      - name: Generate Merged Coverage Report
        run: |
          reportgenerator \
            -reports:"TestResults/coverage-*/coverage.cobertura.xml" \
            -targetdir:"CoverageReport" \
            -reporttypes:Html

      - name: Check Coverage Threshold
        id: coverage-check
        continue-on-error: true
        run: |
          coverage=$(grep -A 1 "Line coverage" CoverageReport/index.html \
            | grep -o '[0-9]\+\.[0-9]\+%' \
            | cut -d'%' -f1)

          echo "Coverage detected: ${coverage}%"
          if (( $(echo "$coverage < 100" | bc -l) )); then
            echo "Coverage below required threshold (100%)"
            exit 1
          fi

          echo "Coverage is 100%"

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport
          path: CoverageReport

      - name: Fail if coverage below threshold
        if: steps.coverage-check.outcome == 'failure'
        run: exit 1
